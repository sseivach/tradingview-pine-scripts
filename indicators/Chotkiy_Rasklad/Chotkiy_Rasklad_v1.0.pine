// This work is licensed under Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International
// https://creativecommons.org/licenses/by-nc-sa/4.0/
// Â© Sergei Seivach

//@version=6
indicator("Chotkiy Rasklad 1.0", overlay=true, max_labels_count=500)

// ==========================================
// 1. SETTINGS
// ==========================================

// --- Trend Filters ---
lenSma = input.int(200, "SMA Length", group="Trend Filters")
lenEma = input.int(200, "EMA Length", group="Trend Filters")

// --- HARSI Settings ---
lenRSI       = input.int(7, "HARSI RSI Length", group="HARSI Settings")
lenSmoothing = input.int(14, "HARSI Smoothing", group="HARSI Settings")
smoothing    = input.int(1, "HARSI Open Smoothing", group="HARSI Settings")

// --- TIME Settings ---
// Format: HHMM-HHMM (Exchange Time / NY Time)
sessMorning = input.session("0945-1130", "Morning Session", group="Time Settings")
sessEvening = input.session("1400-1530", "Evening Session", group="Time Settings")
daysOfWeek  = "1234567" 

// --- DASHBOARD SETTINGS ---
showDash    = input.bool(true, "Show Dashboard", group="Dashboard")
dashSize    = input.string(size.small, "Dashboard Size", options=[size.tiny, size.small, size.normal], group="Dashboard")
// OFFSET FIXED: Now works correctly
dashOffset  = input.int(2, "Dashboard Vertical Offset", minval=0, maxval=15, tooltip="Adds empty rows above the table to move it down", group="Dashboard")

// --- COLORS ---
colLongBright  = color.rgb(0, 255, 51)    // Neon Lime
colLongPale    = color.rgb(131, 255, 135) // Pastel Green
colShortBright = #FF1744   // Neon Red
colShortPale   = #E57373   // Pastel Red
colText        = color.black 
colTextW       = color.white
colExit        = color.gray

// ==========================================
// 2. TIME CHECK
// ==========================================
inMorning = not na(time(timeframe.period, sessMorning + ":" + daysOfWeek))
inEvening = not na(time(timeframe.period, sessEvening + ":" + daysOfWeek))
isGoodTime = inMorning or inEvening

// ==========================================
// 3. CALCULATIONS
// ==========================================

// --- HA Price ---
ha_close = (open + high + low + close) / 4
var float ha_open = na
if na(ha_open)
    ha_open := (open + close) / 2
else
    ha_open := (ha_open[1] + ha_close[1]) / 2

ha_high = math.max(high, math.max(ha_open, ha_close))
ha_low  = math.min(low, math.min(ha_open, ha_close))

isRed   = ha_close < ha_open
isGreen = ha_close > ha_open

// --- Filters ---
smaVal  = ta.sma(close, lenSma)
emaVal  = ta.ema(close, lenEma)
vwapVal = ta.vwap(close)

// --- HARSI ---
zrsi(src, len) => ta.rsi(src, len) - 50
rsiClose      = zrsi(ohlc4, lenRSI)
rsiHighRaw    = zrsi(high, lenRSI)
rsiLowRaw     = zrsi(low, lenRSI)
rsiHighActual = math.max(rsiHighRaw, rsiLowRaw)
rsiLowActual  = math.min(rsiHighRaw, rsiLowRaw)
rsiOpenVirtual = nz(rsiClose[1], rsiClose)
harsi_close    = (rsiOpenVirtual + rsiHighActual + rsiLowActual + rsiClose) / 4

var float harsi_open = na
if na(harsi_open)
    harsi_open := (rsiOpenVirtual + rsiClose) / 2
else
    harsi_open := ((harsi_open * smoothing) + harsi_close[1]) / (smoothing + 1)

isHarsiGreen = harsi_close > harsi_open
isHarsiRed   = harsi_close < harsi_open

// ==========================================
// 4. SIGNAL LOGIC
// ==========================================

threeGreen     = isGreen[0] and isGreen[1] and isGreen[2]
higherLows     = ha_low[2] < ha_low[1] and ha_low[1] < ha_low[0]
higherHighs    = ha_high[2] < ha_high[1] and ha_high[1] < ha_high[0]
bullishTrigger = threeGreen and higherLows and higherHighs

threeRed       = isRed[0] and isRed[1] and isRed[2]
lowerLows      = ha_low[2] > ha_low[1] and ha_low[1] > ha_low[0]
lowerHighs     = ha_high[2] > ha_high[1] and ha_high[1] > ha_high[0]
bearishTrigger = threeRed and lowerLows and lowerHighs

isStrongBull = (close > smaVal) and (close > emaVal) and (close > vwapVal) and isHarsiGreen
isStrongBear = (close < smaVal) and (close < emaVal) and (close < vwapVal) and isHarsiRed

var bool alreadyLong  = false
var bool alreadyShort = false

fireLong  = bullishTrigger and isStrongBull and not alreadyLong
fireShort = bearishTrigger and isStrongBear and not alreadyShort

exitLong  = alreadyLong and isRed
exitShort = alreadyShort and isGreen

if fireLong
    alreadyLong := true
if exitLong
    alreadyLong := false 

if fireShort
    alreadyShort := true
if exitShort
    alreadyShort := false

// ==========================================
// 5. DRAWING SIGNALS
// ==========================================

padding = ta.atr(14) * 0.5
baseText = "3HA+S2+E2\nVWAP+HRSI"
finalTxtBull = isGoodTime ? baseText + "\nTIME" : baseText
finalTxtBear = isGoodTime ? baseText + "\nTIME" : baseText
txtExit      = "EXIT"

if fireLong
    colFinal = isGoodTime ? colLongBright : colLongPale
    label.new(x=bar_index, y=low - padding, text=finalTxtBull, color=colFinal, textcolor=colText, style=label.style_label_up, size=size.tiny)
    alert("LONG ENTRY: " + finalTxtBull, alert.freq_once_per_bar_close)

if fireShort
    colFinal = isGoodTime ? colShortBright : colShortPale
    label.new(x=bar_index, y=high + padding, text=finalTxtBear, color=colFinal, textcolor=colTextW, style=label.style_label_down, size=size.tiny)
    alert("SHORT ENTRY: " + finalTxtBear, alert.freq_once_per_bar_close)

if exitLong
    label.new(x=bar_index, y=low - padding, text=txtExit, color=colExit, textcolor=colTextW, style=label.style_label_up, size=size.tiny)
    alert("EXIT LONG", alert.freq_once_per_bar_close)

if exitShort
    label.new(x=bar_index, y=high + padding, text=txtExit, color=colExit, textcolor=colTextW, style=label.style_label_down, size=size.tiny)
    alert("EXIT SHORT", alert.freq_once_per_bar_close)

// ==========================================
// 6. DASHBOARD LOGIC (FIXED OFFSET)
// ==========================================

int trendStatus = 0
if (close > smaVal and close > emaVal and close > vwapVal)
    trendStatus := 1
else if (close < smaVal and close < emaVal and close < vwapVal)
    trendStatus := -1
else 
    trendStatus := 0 

c_trend = trendStatus == 1 ? colLongBright : trendStatus == -1 ? colShortBright : color.gray
c_harsi = isHarsiGreen ? colLongBright : colShortBright
c_pat   = bullishTrigger ? colLongBright : bearishTrigger ? colShortBright : color.gray
c_time  = isGoodTime ? colLongBright : color.gray

// Create table with extra rows
var table dash = table.new(position.top_right, 2, 25, bgcolor=color.new(color.black, 40), frame_width=1, frame_color=color.black)

if showDash and barstate.islast
    // FIX: Loop to create empty invisible cells to force the offset
    if dashOffset > 0
        for i = 0 to dashOffset - 1
            table.cell(dash, 0, i, " ", text_size=dashSize, bgcolor=color.new(color.black, 100))
            table.cell(dash, 1, i, " ", text_size=dashSize, bgcolor=color.new(color.black, 100))

    // Header
    table.cell(dash, 0, 0 + dashOffset, "ROYAL FLUSH", text_color=color.white, text_size=dashSize, bgcolor=color.new(color.blue, 60))
    table.merge_cells(dash, 0, 0 + dashOffset, 1, 0 + dashOffset)
    
    // Row 1: Trend
    table.cell(dash, 0, 1 + dashOffset, "TREND", text_color=color.white, text_size=dashSize, text_halign=text.align_left)
    table.cell(dash, 1, 1 + dashOffset, trendStatus == 1 ? "BULL" : trendStatus == -1 ? "BEAR" : "FLAT", text_color=color.black, bgcolor=c_trend, text_size=dashSize)

    // Row 2: Momentum
    table.cell(dash, 0, 2 + dashOffset, "HARSI", text_color=color.white, text_size=dashSize, text_halign=text.align_left)
    table.cell(dash, 1, 2 + dashOffset, isHarsiGreen ? "UP" : "DOWN", text_color=color.black, bgcolor=c_harsi, text_size=dashSize)

    // Row 3: Pattern
    table.cell(dash, 0, 3 + dashOffset, "3HA PAT", text_color=color.white, text_size=dashSize, text_halign=text.align_left)
    table.cell(dash, 1, 3 + dashOffset, bullishTrigger ? "LONG" : bearishTrigger ? "SHORT" : "WAIT", text_color=color.black, bgcolor=c_pat, text_size=dashSize)
    
    // Row 4: Time
    table.cell(dash, 0, 4 + dashOffset, "SESSION", text_color=color.white, text_size=dashSize, text_halign=text.align_left)
    table.cell(dash, 1, 4 + dashOffset, isGoodTime ? "ON" : "OFF", text_color=color.black, bgcolor=c_time, text_size=dashSize)

alertcondition(fireLong, title="Royal Flush CALL", message="Entry Long")
alertcondition(fireShort, title="Royal Flush PUT", message="Entry Short")
alertcondition(exitLong, title="Exit CALL", message="Close Long")
alertcondition(exitShort, title="Exit PUT", message="Close Short")