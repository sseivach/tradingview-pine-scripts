// This work is licensed under Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International
// https://creativecommons.org/licenses/by-nc-sa/4.0/
// Â© Sergei Seivach

//@version=6
indicator("Chotkiy Rasklad 1.2 (Synced Order)", overlay=true, max_labels_count=500)

// ==========================================
// 1. SETTINGS
// ==========================================

// --- Trend Filters ---
lenSma = input.int(200, "SMA Length", group="Trend Filters")
lenEma = input.int(200, "EMA Length", group="Trend Filters")

// --- HARSI Settings ---
lenRSI       = input.int(7, "HARSI RSI Length", group="HARSI Settings")
lenSmoothing = input.int(14, "HARSI Smoothing", group="HARSI Settings")
smoothing    = input.int(1, "HARSI Open Smoothing", group="HARSI Settings")

// --- TIME Settings ---
// Format: HHMM-HHMM (Exchange Time / NY Time)
sessOpen    = input.session("0930-0945", "Opening Mess", group="Time Settings")    // The chaotic open
sessMorning = input.session("0945-1130", "Morning Session", group="Time Settings") // Best trend time
sessEvening = input.session("1400-1530", "Evening Session", group="Time Settings") // Power hour
daysOfWeek  = "1234567" 

// --- DASHBOARD SETTINGS ---
showDash    = input.bool(true, "Show Dashboard", group="Dashboard")
dashSize    = input.string(size.small, "Dashboard Size", options=[size.tiny, size.small, size.normal], group="Dashboard")
// OFFSETS
dashOffsetV = input.int(2, "Vertical Offset (Top)", minval=0, maxval=20, group="Dashboard")
dashOffsetH = input.int(2, "Horizontal Offset (Right)", minval=0, maxval=10, group="Dashboard")

// --- COLORS ---
colLongBright  = color.rgb(0, 255, 51)    // Neon Lime
colLongPale    = color.rgb(131, 255, 135) // Pastel Green
colShortBright = #FF1744   // Neon Red
colShortPale   = #E57373   // Pastel Red
colText        = color.black 
colTextW       = color.white
colExit        = color.gray

// Backgrounds
colDarkBg      = color.rgb(10, 10, 10, 0)    // Solid Dark Background
colTransp      = color.new(color.black, 100) // Invisible

// ==========================================
// 2. TIME CHECK
// ==========================================
// Check time zones
inOpen    = not na(time(timeframe.period, sessOpen + ":" + daysOfWeek))
inMorning = not na(time(timeframe.period, sessMorning + ":" + daysOfWeek))
inEvening = not na(time(timeframe.period, sessEvening + ":" + daysOfWeek))

// "Good Time" is strictly the active trend sessions (Morning + Evening)
isGoodTime = inMorning or inEvening

// ==========================================
// 3. CALCULATIONS
// ==========================================

// --- HA Price ---
ha_close = (open + high + low + close) / 4
var float ha_open = na
if na(ha_open)
    ha_open := (open + close) / 2
else
    ha_open := (ha_open[1] + ha_close[1]) / 2

ha_high = math.max(high, math.max(ha_open, ha_close))
ha_low  = math.min(low, math.min(ha_open, ha_close))

isRed   = ha_close < ha_open
isGreen = ha_close > ha_open

// --- Filters ---
smaVal  = ta.sma(close, lenSma)
emaVal  = ta.ema(close, lenEma)
vwapVal = ta.vwap(close)

// --- HARSI ---
zrsi(src, len) => ta.rsi(src, len) - 50
rsiClose      = zrsi(ohlc4, lenRSI)
rsiHighRaw    = zrsi(high, lenRSI)
rsiLowRaw     = zrsi(low, lenRSI)
rsiHighActual = math.max(rsiHighRaw, rsiLowRaw)
rsiLowActual  = math.min(rsiHighRaw, rsiLowRaw)
rsiOpenVirtual = nz(rsiClose[1], rsiClose)
harsi_close    = (rsiOpenVirtual + rsiHighActual + rsiLowActual + rsiClose) / 4
var float harsi_open = na
if na(harsi_open)
    harsi_open := (rsiOpenVirtual + rsiClose) / 2
else
    harsi_open := ((harsi_open * smoothing) + harsi_close[1]) / (smoothing + 1)

isHarsiGreen = harsi_close > harsi_open
isHarsiRed   = harsi_close < harsi_open

// ==========================================
// 4. SIGNAL LOGIC
// ==========================================

// --- Patterns ---
threeGreen     = isGreen[0] and isGreen[1] and isGreen[2]
higherLows     = ha_low[2] < ha_low[1] and ha_low[1] < ha_low[0]
higherHighs    = ha_high[2] < ha_high[1] and ha_high[1] < ha_high[0]
bullishTrigger = threeGreen and higherLows and higherHighs

threeRed       = isRed[0] and isRed[1] and isRed[2]
lowerLows      = ha_low[2] > ha_low[1] and ha_low[1] > ha_low[0]
lowerHighs     = ha_high[2] > ha_high[1] and ha_high[1] > ha_high[0]
bearishTrigger = threeRed and lowerLows and lowerHighs

// --- Strong Filters ---
isStrongBull = (close > smaVal) and (close > emaVal) and (close > vwapVal) and isHarsiGreen
isStrongBear = (close < smaVal) and (close < emaVal) and (close < vwapVal) and isHarsiRed

var bool alreadyLong  = false
var bool alreadyShort = false

fireLong  = bullishTrigger and isStrongBull and not alreadyLong
fireShort = bearishTrigger and isStrongBear and not alreadyShort

exitLong  = alreadyLong and isRed
exitShort = alreadyShort and isGreen

if fireLong
    alreadyLong := true
if exitLong
    alreadyLong := false 

if fireShort
    alreadyShort := true
if exitShort
    alreadyShort := false

// ==========================================
// 5. DRAWING SIGNALS
// ==========================================

padding = ta.atr(14) * 0.5
// Label Order: 3HA -> S2 -> E2 -> VWAP -> HRSI
baseText = "3HA+S2+E2\nVWAP+HRSI"
finalTxtBull = isGoodTime ? baseText + "\nTIME" : baseText
finalTxtBear = isGoodTime ? baseText + "\nTIME" : baseText
txtExit      = "EXIT"

if fireLong
    colFinal = isGoodTime ? colLongBright : colLongPale
    label.new(x=bar_index, y=low - padding, text=finalTxtBull, color=colFinal, textcolor=colText, style=label.style_label_up, size=size.tiny)
    alert("LONG ENTRY: " + finalTxtBull, alert.freq_once_per_bar_close)

if fireShort
    colFinal = isGoodTime ? colShortBright : colShortPale
    label.new(x=bar_index, y=high + padding, text=finalTxtBear, color=colFinal, textcolor=colTextW, style=label.style_label_down, size=size.tiny)
    alert("SHORT ENTRY: " + finalTxtBear, alert.freq_once_per_bar_close)

if exitLong
    label.new(x=bar_index, y=low - padding, text=txtExit, color=colExit, textcolor=colTextW, style=label.style_label_up, size=size.tiny)
    alert("EXIT LONG", alert.freq_once_per_bar_close)

if exitShort
    label.new(x=bar_index, y=high + padding, text=txtExit, color=colExit, textcolor=colTextW, style=label.style_label_down, size=size.tiny)
    alert("EXIT SHORT", alert.freq_once_per_bar_close)

// ==========================================
// 6. DASHBOARD LOGIC (SYNCED ORDER)
// ==========================================

// --- Prepare Data ---
s_sma   = close > smaVal
s_ema   = close > emaVal
s_vwap  = close > vwapVal

c_sma   = s_sma ? colLongBright : colShortBright
c_ema   = s_ema ? colLongBright : colShortBright
c_vwap  = s_vwap ? colLongBright : colShortBright
c_harsi = isHarsiGreen ? colLongBright : colShortBright

// --- TIME STATUS LOGIC ---
string txtTime = "QUIET"
color c_time   = color.gray

if inOpen
    txtTime := "MESS"
    c_time  := colShortBright // Red (Danger)
else if isGoodTime
    txtTime := "GOOD"
    c_time  := colLongBright  // Green (Active)
else
    txtTime := "QUIET"
    c_time  := color.gray     // Gray (Lunch/Post-market)

// --- Pattern Logic ---
c_pat = color.gray
if bullishTrigger 
    c_pat := colLongBright
else if bearishTrigger
    c_pat := colShortBright

// --- Action Logic ---
string sigTxt = "WAIT"
color c_sig   = color.gray

if alreadyLong
    sigTxt := "IN LONG"
    c_sig := colLongPale
else if alreadyShort
    sigTxt := "IN SHORT"
    c_sig := colShortPale
else if bullishTrigger and isStrongBull
    sigTxt := "BUY NOW"
    c_sig := colLongBright
else if bearishTrigger and isStrongBear
    sigTxt := "SELL NOW"
    c_sig := colShortBright

// --- DRAW TABLE ---
totalCols = 2 + dashOffsetH
var table dash = table.new(position.top_right, totalCols, 40, bgcolor=colTransp, frame_width=0, border_width=0)

if showDash and barstate.islast
    
    // 1. FILL TRANSPARENT OFFSETS
    if dashOffsetV > 0
        for r = 0 to dashOffsetV - 1
            for c = 0 to totalCols - 1
                table.cell(dash, c, r, "", bgcolor=colTransp)
    
    if dashOffsetH > 0
        for c = 2 to totalCols - 1
            for r = 0 to 30 
                table.cell(dash, c, r, "   ", bgcolor=colTransp)

    // Helper
    r = dashOffsetV

    // --- HEADER: RASKLAD ---
    table.cell(dash, 0, r, "RASKLAD", text_color=color.white, text_size=dashSize, bgcolor=color.new(color.blue, 50))
    table.merge_cells(dash, 0, r, 1, r)
    r += 1

    // --- INDICATORS LIST ---
    // Order now matches label: 3HA -> S2 -> E2 -> VWAP -> HRSI
    
    // 1. 3 HAshi (Pattern)
    table.cell(dash, 0, r, "3 HAshi", text_color=color.white, text_size=dashSize, text_halign=text.align_left, bgcolor=colDarkBg)
    table.cell(dash, 1, r, bullishTrigger ? "LONG" : bearishTrigger ? "SHORT" : "---", text_color=color.black, bgcolor=c_pat, text_size=dashSize)
    r += 1
    
    // 2. SMA 200
    table.cell(dash, 0, r, "SMA 200", text_color=color.white, text_size=dashSize, text_halign=text.align_left, bgcolor=colDarkBg)
    table.cell(dash, 1, r, s_sma ? "BULL" : "BEAR", text_color=color.black, bgcolor=c_sma, text_size=dashSize)
    r += 1

    // 3. EMA 200
    table.cell(dash, 0, r, "EMA 200", text_color=color.white, text_size=dashSize, text_halign=text.align_left, bgcolor=colDarkBg)
    table.cell(dash, 1, r, s_ema ? "BULL" : "BEAR", text_color=color.black, bgcolor=c_ema, text_size=dashSize)
    r += 1

    // 4. VWAP
    table.cell(dash, 0, r, "VWAP", text_color=color.white, text_size=dashSize, text_halign=text.align_left, bgcolor=colDarkBg)
    table.cell(dash, 1, r, s_vwap ? "BULL" : "BEAR", text_color=color.black, bgcolor=c_vwap, text_size=dashSize)
    r += 1

    // 5. HARSI
    table.cell(dash, 0, r, "HARSI", text_color=color.white, text_size=dashSize, text_halign=text.align_left, bgcolor=colDarkBg)
    table.cell(dash, 1, r, isHarsiGreen ? "UP" : "DOWN", text_color=color.black, bgcolor=c_harsi, text_size=dashSize)
    r += 1

    // 6. TIME (Context)
    table.cell(dash, 0, r, "TIME", text_color=color.white, text_size=dashSize, text_halign=text.align_left, bgcolor=colDarkBg)
    table.cell(dash, 1, r, txtTime, text_color=color.black, bgcolor=c_time, text_size=dashSize)
    r += 1

    // --- SEPARATOR ---
    table.cell(dash, 0, r, "---------------------", text_color=color.gray, text_size=size.tiny, bgcolor=colDarkBg)
    table.merge_cells(dash, 0, r, 1, r)
    r += 1

    // --- ACTION ---
    table.cell(dash, 0, r, "ACTION", text_color=color.white, text_size=dashSize, text_halign=text.align_left, bgcolor=colDarkBg)
    table.cell(dash, 1, r, sigTxt, text_color=color.black, bgcolor=c_sig, text_size=dashSize)

alertcondition(fireLong, title="Royal Flush CALL", message="Entry Long")
alertcondition(fireShort, title="Royal Flush PUT", message="Entry Short")
alertcondition(exitLong, title="Exit CALL", message="Close Long")
alertcondition(exitShort, title="Exit PUT", message="Close Short")